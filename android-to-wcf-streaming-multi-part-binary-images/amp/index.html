<!doctype html>
<html amp lang="en-US">

<!-- Mirrored from www.bluelabellabs.com/android-to-wcf-streaming-multi-part-binary-images/amp/ by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 20 Nov 2018 06:31:07 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
		<title>Android to WCF: Streaming multi part binary images</title>
		<link rel="canonical" href="../index.html"/>
	<script type='text/javascript' src='../../../cdn.ampproject.org/v0.js' async></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic"><style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>	<script type="application/ld+json">{"@context":"http:\/\/schema.org","publisher":{"@type":"Organization","name":"Blue Label Labs","logo":{"@type":"ImageObject","url":"https:\/\/www.bluelabellabs.com\/wp-content\/uploads\/2018\/08\/android-chrome-256x256-120x120.png","height":32,"width":32}},"@type":"BlogPosting","mainEntityOfPage":"https:\/\/www.bluelabellabs.com\/android-to-wcf-streaming-multi-part-binary-images\/","headline":"Android to WCF: Streaming multi part binary images","datePublished":"2011-05-30T17:04:33+00:00","dateModified":"2011-05-30T17:04:33+00:00","author":{"@type":"Person","name":"Bobby Gill"}}</script>
	<meta name="generator" content="AMP Plugin v0.7.2"/>	<style amp-custom>.alignright{float:right}.alignleft{float:left}.aligncenter{display:block;margin-left:auto;margin-right:auto}.amp-wp-enforced-sizes{max-width:100%;margin:0 auto}.amp-wp-unknown-size img{object-fit:contain}.amp-wp-content,.amp-wp-title-bar div{margin:0 auto;max-width:900px}html{background:#0a89c0}body{background:#fff;color:#353535;font-family:'Merriweather','Times New Roman',Times,serif;font-weight:300;line-height:1.75em}p,ol,ul,figure{margin:0 0 1em;padding:0}a,a:visited{color:#0a89c0}a:hover,a:active,a:focus{color:#353535}blockquote{color:#353535;background:rgba(127,127,127,.125);border-left:2px solid #0a89c0;margin:8px 0 24px 0;padding:16px}blockquote p:last-child{margin-bottom:0}.amp-wp-meta,.amp-wp-header div,.amp-wp-title,.wp-caption-text,.amp-wp-tax-category,.amp-wp-tax-tag,.amp-wp-comments-link,.amp-wp-footer p,.back-to-top{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Roboto","Oxygen-Sans","Ubuntu","Cantarell","Helvetica Neue",sans-serif}.amp-wp-header{background-color:#0a89c0}.amp-wp-header div{color:#fff;font-size:1em;font-weight:400;margin:0 auto;max-width:calc(840px - 32px);padding:.875em 16px;position:relative}.amp-wp-header a{color:#fff;text-decoration:none}.amp-wp-header .amp-wp-site-icon{background-color:#fff;border:1px solid #fff;border-radius:50%;position:absolute;right:18px;top:10px}.amp-wp-article{color:#353535;font-weight:400;margin:1.5em auto;max-width:840px;overflow-wrap:break-word;word-wrap:break-word}.amp-wp-article-header{align-items:center;align-content:stretch;display:flex;flex-wrap:wrap;justify-content:space-between;margin:1.5em 16px 0}.amp-wp-title{color:#353535;display:block;flex:1 0 100%;font-weight:900;margin:0 0 .625em;width:100%}.amp-wp-meta{color:#696969;display:inline-block;flex:2 1 50%;font-size:.875em;line-height:1.5em;margin:0 0 1.5em;padding:0}.amp-wp-article-header .amp-wp-meta:last-of-type{text-align:right}.amp-wp-article-header .amp-wp-meta:first-of-type{text-align:left}.amp-wp-byline amp-img,.amp-wp-byline .amp-wp-author{display:inline-block;vertical-align:middle}.amp-wp-byline amp-img{border:1px solid #0a89c0;border-radius:50%;position:relative;margin-right:6px}.amp-wp-posted-on{text-align:right}.amp-wp-article-featured-image{margin:0 0 1em}.amp-wp-article-featured-image amp-img{margin:0 auto}.amp-wp-article-featured-image.wp-caption .wp-caption-text{margin:0 18px}.amp-wp-article-content{margin:0 16px}.amp-wp-article-content ul,.amp-wp-article-content ol{margin-left:1em}.amp-wp-article-content amp-img{margin:0 auto}.amp-wp-article-content amp-img.alignright{margin:0 0 1em 16px}.amp-wp-article-content amp-img.alignleft{margin:0 16px 1em 0}.wp-caption{padding:0}.wp-caption.alignleft{margin-right:16px}.wp-caption.alignright{margin-left:16px}.wp-caption .wp-caption-text{border-bottom:1px solid #c2c2c2;color:#696969;font-size:.875em;line-height:1.5em;margin:0;padding:.66em 10px .75em}amp-carousel{background:#c2c2c2;margin:0 -16px 1.5em}amp-iframe,amp-youtube,amp-instagram,amp-vine{background:#c2c2c2;margin:0 -16px 1.5em}.amp-wp-article-content amp-carousel amp-img{border:none}amp-carousel>amp-img>img{object-fit:contain}.amp-wp-iframe-placeholder{background:#c2c2c2 url(../../wp-content/plugins/amp/assets/images/placeholder-icon.png) no-repeat center 40%;background-size:48px 48px;min-height:48px}.amp-wp-article-footer .amp-wp-meta{display:block}.amp-wp-tax-category,.amp-wp-tax-tag{color:#696969;font-size:.875em;line-height:1.5em;margin:1.5em 16px}.amp-wp-comments-link{color:#696969;font-size:.875em;line-height:1.5em;text-align:center;margin:2.25em 0 1.5em}.amp-wp-comments-link a{border-style:solid;border-color:#c2c2c2;border-width:1px 1px 2px;border-radius:4px;background-color:transparent;color:#0a89c0;cursor:pointer;display:block;font-size:14px;font-weight:600;line-height:18px;margin:0 auto;max-width:200px;padding:11px 16px;text-decoration:none;width:50%;-webkit-transition:background-color .2s ease;transition:background-color .2s ease}.amp-wp-footer{border-top:1px solid #c2c2c2;margin:calc(1.5em - 1px) 0 0}.amp-wp-footer div{margin:0 auto;max-width:calc(840px - 32px);padding:1.25em 16px 1.25em;position:relative}.amp-wp-footer h2{font-size:1em;line-height:1.375em;margin:0 0 .5em}.amp-wp-footer p{color:#696969;font-size:.8em;line-height:1.5em;margin:0 85px 0 0}.amp-wp-footer a{text-decoration:none}.back-to-top{bottom:1.275em;font-size:.8em;font-weight:600;line-height:2em;position:absolute;right:16px}</style>
</head>

<body class="">

<header id="top" class="amp-wp-header">
	<div>
		<a href="../../index.html">
										<amp-img src="../../wp-content/uploads/2018/08/android-chrome-256x256-120x120.png" width="32" height="32" class="amp-wp-site-icon"></amp-img>
						<span class="amp-site-title">
				Blue Label Labs			</span>
		</a>
	</div>
</header>

<article class="amp-wp-article">
	<header class="amp-wp-article-header">
		<h1 class="amp-wp-title">Android to WCF: Streaming multi part binary images</h1>
			<div class="amp-wp-meta amp-wp-byline">
					<amp-img src="https://secure.gravatar.com/avatar/2218e5a5d37f457d40fe995c4202edbf?s=24&amp;d=mm&amp;r=g" alt="Bobby Gill" width="24" height="24" layout="fixed"></amp-img>
				<span class="amp-wp-author author vcard">Bobby Gill</span>
	</div>
<div class="amp-wp-meta amp-wp-posted-on">
	<time datetime="2011-05-30T17:04:33+00:00">
		7 years ago	</time>
</div>
	</header>

	
	<div class="amp-wp-article-content">
		<p>I know I have been getting little twitches of wood just thinking about how awesome this post is going to be. But first:</p><p><strong>What the hell is multi-part messaging? (or MIME for the acronym obsessed)</strong></p><p>Up until 3 weeks ago, MIME was just a word I had only seen in the garbled mess of an .toString() email header. I am not sure what I thought of ‘MIME’ when I used to see it amongst all the other courier-font’ed crap in an Outlook email window. Usually, I only got to see the email headers as a result of an email thread being completely fucked up by too many replies, and Outlook then doing a spot-on rendition  of NASA Launch Control circa January 1986.</p><p>I still am not quite sure what it is. But here is a great link:</p><p><a href="http://www.creative-wisdom.com/teaching/network/mime.shtml" target="_blank">http://www.creative-wisdom.com/teaching/network/mime.shtml</a></p><p>Look at that, that link is legit. It really does look like it was built in 1995 with Netscape Communicator 4.1.</p><p>But back to MIME, it’s a way of formatting disparate types of data in a manner that allows it to be sent across the wire. It’s really not all that interesting.  If you really want to know, check out the RFC:</p><p><a href="http://www.ietf.org/rfc/rfc2045.txt" target="_blank">http://www.ietf.org/rfc/rfc2045.txt</a></p><p><strong>Who writes these RFCs?</strong></p><p>Seriously, 40 pages describing MIME? I think I’d rather perform ocular plastic surgery on myself with a flashlight and an exacto knife before you could get me to be apart of one of these nerd fest RFC groups.</p><p><strong>The problem: Sending a picture from Android to WCF</strong></p><p>Nobody cares about MIME. Im just going to say it, because we’re all thinking it. Back to the problem, my application takes pictures on the phone and needs to upload it to a central server (which is running WCF). Now there are two ways to go about doing this, one way is defining a method signature on your server such as:</p><pre class="csharpcode"><span class="kwrd">public</span> <span class="kwrd">void</span> uploadImage(<span class="kwrd">byte</span>[] imageBytes);</pre><p>Now this works fine if you have a small amount of data to send. However, if you are sending a MBytes, GBytes, or even TBytes, this is not a good design choice. Primarily because before the method is executed by WCF, the entire contents of imageBytes will be loaded into memory. I think its not hard to see why that might be a problem in large file cases.</p><p>Also, WCF is primarily an XML driven messaging platform. It works great if you are actually sending text, but really, if I am sending a picture, should that be encoded into XML? That doesn’t make a lot of sense.</p><p><strong>WCF &amp; MTOM: Don’t buffer it, stream it</strong></p><p>WCF implements MTOM (Im not sure what it stands for, and I am sure nobody cares) . It’s a protocol enhancement which allows for large binary data to be streamed across the wire in a sequence of MIME formatted messages. Further, it also allows for the binary data to be transmitted as binary data, and not need to be encoded in XML.</p><p><strong>So putting it into code: using MTOM to transmit a picture to a web service:</strong></p><p><em>Method Signature: </em>Your WCF operation contract would now look something like:</p><pre class="csharpcode"><span class="kwrd">public</span> <span class="kwrd">void</span> uploadImage(Stream image)</pre><p>That’s just a regular ole System.IO.Stream object. Now in your URL template for the WCF operation, you would not include any reference to {image} , since this parameter will not be apart of the method signature.</p><p>Instead, when WCF sees this signature, and then figures out the {image} parameter is not part of the URL template, it knows to look in the body of the HTTP request to find the beginning of a MIME sequenced stream of data.</p><p>As you read the stream in your code, WCF under the covers is streaming forward the bytes received, as opposed to waiting for it to all download and then overload your memory</p><p><strong>But wait, you need to adjust your bindings</strong></p><p>It wouldn’t be WCF if you didn’t have to fiddle with XML somewhere. In this case, to enable WCF to stream binary data as mentioned above, you need to modify the binding configuration to enable streaming, and to increase your max message sized received from the default 65000:</p><pre class="csharpcode"><span class="kwrd">&lt;</span><span class="html">bindings</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">webHttpBinding</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">binding</span> <span class="attr">maxReceivedMessageSize</span><span class="kwrd">="10000000"</span> <span class="attr">maxBufferSize</span><span class="kwrd">="10000000"</span> <span class="attr">transferMode</span><span class="kwrd">="Streamed"</span><span class="kwrd">/&gt;</span>
      <span class="kwrd">&lt;/</span><span class="html">webHttpBinding</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">bindings</span><span class="kwrd">&gt;</span></pre><p><strong>On Android, the code to consume a WCF web service with a Stream parameter:</strong></p><p>It’s really simple once you get the right JARs. Android evidently doesn’t ship with the full complement of Apache HTTP libraries in JAVA. So you will need to download the following two and link them in your Eclipse project:</p><p>apache-mime4j-0.6.1.jar</p><p>httpmime-4.0.1.jar</p><p>After that, its all gravy son. Your code will look something like this:</p><pre class="csharpcode">DefaultHttpClient httpclient = <span class="kwrd">new</span> DefaultHttpClient();
HttpPost httppost = <span class="kwrd">new</span> HttpPost(query);
ResponseHandler&lt;String&gt; responseHandler = <span class="kwrd">new</span> BasicResponseHandler();

<span class="rem">//This is the new shit to deal with MIME</span>
MultipartEntity entity = <span class="kwrd">new</span> MultipartEntity();
entity.addPart(<span class="str">"image"</span>, <span class="kwrd">new</span> FileBody(imageFile, <span class="str">"image/jpeg"</span>));
httppost.setEntity(entity);

String responseString = httpclient.execute(httppost, responseHandler);</pre><p><a href="http://www.youtube.com/watch?v=W45DRy7M1no" target="_blank">Boom goes the dynamite.</a></p><p><strong>WTF?! My binary data contains more bytes when I read the Stream in WCF than when I send it from Android</strong></p><p>Now here’s the rub. This one snagged me for a couple of days, because the pictures I was receiving in the WCF were larger than what was sent from Android.</p><p>Turns out that when WCF reads in this streamed data, it also appends the MIME header to the start of the Stream. I’m not sure why, but you need to strip this header out in order to retain fidelity of the original data.</p><p>Naturally there really wasn’t an easy way to do this. But if you look at Wireshark, you will see the MIME header has a standard text pattern.  I hacked together this lovely piece of code to get rid of it:</p><pre class="csharpcode">        <span class="kwrd">internal</span> <span class="kwrd">static</span> <span class="kwrd">byte</span>[] GetBytesFromStream(Stream stream, System.Text.Encoding encoding)
        {

            <span class="rem">// Read the stream into a byte array</span>
            <span class="kwrd">byte</span>[] data = ToByteArray(stream);
            List&lt;<span class="kwrd">byte</span>&gt; dataList = <span class="kwrd">new</span> List&lt;<span class="kwrd">byte</span>&gt;();

            <span class="rem">// Copy to a string for header parsing</span>
            <span class="kwrd">string</span> content = encoding.GetString(data);

            <span class="kwrd">string</span> matchValue = <span class="str">"Content-Transfer-Encoding: binaryrnrn"</span>;
            <span class="kwrd">int</span> lastIndex = content.LastIndexOf(matchValue);

            <span class="kwrd">int</span> startingIndex = lastIndex + matchValue.Length;

            <span class="kwrd">byte</span>[] bytes = encoding.GetBytes(content.Substring(0, startingIndex - 1));
            <span class="kwrd">int</span> bytesLength = bytes.Length;

            <span class="kwrd">for</span> (<span class="kwrd">int</span> i = bytesLength + 1; i &lt; data.Length; i++)
            {
                dataList.Add(data[i]);
            }

            <span class="kwrd">return</span> dataList.ToArray();
        }</pre><pre class="csharpcode"></pre><p>And voila, at the end of it, I had my original piece of binary data as sent from the Android device.</p><p><strong>Coming next week, what to do when your Android device becomes a closet stoner</strong></p><div class="swp-content-locator"></div>	</div>

	<footer class="amp-wp-article-footer">
			<div class="amp-wp-meta amp-wp-tax-category">
		Categories: <a href="../../category/how-to-android/index.html" rel="tag">Android</a>, <a href="../../category/development/index.html" rel="tag">Development</a>	</div>

	<div class="amp-wp-meta amp-wp-tax-tag">
		Tags: <a href="../../tag/android/index.html" rel="tag">android</a>, <a href="../../tag/android-mtom-wcf/index.html" rel="tag">Android MTOM WCF</a>, <a href="../../tag/android-to-wcf/index.html" rel="tag">android to wcf</a>, <a href="../../tag/how-to-guides/index.html" rel="tag">how-to-guides</a>, <a href="../../tag/mime/index.html" rel="tag">MIME</a>, <a href="../../tag/mime-from-android-to-wcf/index.html" rel="tag">mime from android to wcf</a>, <a href="../../tag/mime-to-wcf/index.html" rel="tag">mime to wcf</a>, <a href="../../tag/multi-part-messages-wcf/index.html" rel="tag">multi-part messages WCF</a>, <a href="../../tag/wcf/index.html" rel="tag">wcf</a>, <a href="../../tag/wcf-binary-streaming/index.html" rel="tag">WCF binary streaming</a>, <a href="../../tag/wcf-streaming/index.html" rel="tag">WCF streaming</a>	</div>
		<div class="amp-wp-meta amp-wp-comments-link">
		<a href="../index.html#comments">
			Leave a Comment		</a>
	</div>
	</footer>
</article>

<footer class="amp-wp-footer">
	<div>
		<h2>Blue Label Labs</h2>
		<p>
			<a href="https://wordpress.org/">
				Powered by WordPress			</a>
		</p>
		<a href="#top" class="back-to-top">Back to top</a>
	</div>
</footer>



</body>

<!-- Mirrored from www.bluelabellabs.com/android-to-wcf-streaming-multi-part-binary-images/amp/ by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 20 Nov 2018 06:31:08 GMT -->
</html>
